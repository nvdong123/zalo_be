#!/usr/bin/env python3
"""
Script l√†m s·∫°ch v√† t·∫°o l·∫°i d·ªØ li·ªáu demo ho√†n to√†n m·ªõi
"""

import pymysql
from datetime import datetime, date, timedelta
import json

# Database config cho VPS - s·ª≠ d·ª•ng c√πng user v·ªõi API
DB_CONFIG = {
    'host': 'localhost',
    'user': 'hotel_app_user',
    'password': 'HotelApp2025!@#Secure',
    'database': 'bookingservicesiovn_zalominidb',
    'charset': 'utf8mb4'
}

def clean_demo_data():
    """X√≥a t·∫•t c·∫£ d·ªØ li·ªáu demo c≈©"""
    try:
        connection = pymysql.connect(**DB_CONFIG)
        cursor = connection.cursor()
        
        print("üßπ X√ìA D·ªÆ LI·ªÜU DEMO C≈®...")
        print("=" * 50)
        
        # X√≥a theo th·ª© t·ª± ƒë·ªÉ tr√°nh foreign key constraint
        tables_to_clean = [
            'tbl_customer_vouchers',
            'tbl_service_bookings', 
            'tbl_room_stays',
            'tbl_booking_requests',
            'tbl_vouchers',
            'tbl_promotions',
            'tbl_customers',
            'tbl_facility_features',
            'tbl_facilities',
            'tbl_room_features',
            'tbl_room_amenities',
            'tbl_rooms',
            'tbl_services',
            'tbl_hotel_brands',
            'tbl_admin_users',
            'tbl_tenants'
        ]
        
        for table in tables_to_clean:
            try:
                cursor.execute(f"DELETE FROM {table} WHERE created_by = 'demo_script' OR created_by = 'system'")
                deleted = cursor.rowcount
                if deleted > 0:
                    print(f"   üóëÔ∏è  {table}: {deleted} records deleted")
            except Exception as e:
                print(f"   ‚ö†Ô∏è  {table}: {e}")
        
        connection.commit()
        print("‚úÖ D·ªØ li·ªáu c≈© ƒë√£ ƒë∆∞·ª£c x√≥a!")
        
        return True
        
    except Exception as e:
        print(f"‚ùå L·ªói khi x√≥a d·ªØ li·ªáu: {e}")
        return False
    finally:
        if 'connection' in locals():
            connection.close()

def create_fresh_demo_data():
    """T·∫°o d·ªØ li·ªáu demo ho√†n to√†n m·ªõi"""
    
    try:
        connection = pymysql.connect(**DB_CONFIG)
        cursor = connection.cursor()
        
        print("\nüè® T·∫†O D·ªÆ LI·ªÜU DEMO M·ªöI")
        print("=" * 50)
        
        current_time = datetime.now()
        
        # 1. T·∫°o Admin Users sau (s·∫Ω update tenant_id sau khi t·∫°o tenants)
        print("üë§ T·∫°o Admin Users...")
        admin_users = [
            {
                'tenant_id': None, 'username': 'superadmin', 'email': 'admin@hotel-saas.com',
                'password': 'admin123', 'role': 'super_admin'
            }
        ]
        
        import hashlib
        for admin in admin_users:
            hashed_password = hashlib.sha256(admin['password'].encode()).hexdigest()
            cursor.execute("""
                INSERT INTO tbl_admin_users (
                    tenant_id, username, hashed_password, email, role, status,
                    created_at, updated_at, created_by
                ) VALUES (%s, %s, %s, %s, %s, 'active', %s, %s, 'demo_script')
            """, (
                admin['tenant_id'], admin['username'], hashed_password,
                admin['email'], admin['role'], current_time, current_time
            ))
            print(f"   ‚úÖ {admin['username']} ({admin['role']})")
        
        # 2. T·∫°o Tenants
        print("üè¢ T·∫°o Tenants...")
        tenants_data = [
            {'name': 'Grand Hotel Chain', 'domain': 'grandhotel.vn'},
            {'name': 'Beach Resort Group', 'domain': 'beachresort.vn'}
        ]
        
        tenant_ids = {}
        for tenant in tenants_data:
            cursor.execute("""
                INSERT INTO tbl_tenants (name, domain, status, created_at, updated_at, created_by)
                VALUES (%s, %s, 'active', %s, %s, 'demo_script')
            """, (tenant['name'], tenant['domain'], current_time, current_time))
            tenant_id = cursor.lastrowid
            tenant_ids[tenant['name']] = tenant_id
            print(f"   ‚úÖ {tenant['name']} (ID: {tenant_id})")
        
        grand_hotel_tenant_id = tenant_ids['Grand Hotel Chain']
        beach_resort_tenant_id = tenant_ids['Beach Resort Group']
        
        # T·∫°o hotel admin users v·ªõi tenant_id ƒë√∫ng
        print("üë§ T·∫°o Hotel Admin Users...")
        hotel_admins = [
            {
                'tenant_id': grand_hotel_tenant_id, 'username': 'admin_grand', 
                'email': 'admin@grandhotel.com', 'password': 'admin123', 'role': 'hotel_admin'
            },
            {
                'tenant_id': beach_resort_tenant_id, 'username': 'admin_beach',
                'email': 'admin@beachresort.com', 'password': 'admin123', 'role': 'hotel_admin'
            }
        ]
        
        for admin in hotel_admins:
            hashed_password = hashlib.sha256(admin['password'].encode()).hexdigest()
            cursor.execute("""
                INSERT INTO tbl_admin_users (
                    tenant_id, username, hashed_password, email, role, status,
                    created_at, updated_at, created_by
                ) VALUES (%s, %s, %s, %s, %s, 'active', %s, %s, 'demo_script')
            """, (
                admin['tenant_id'], admin['username'], hashed_password,
                admin['email'], admin['role'], current_time, current_time
            ))
            print(f"   ‚úÖ {admin['username']} (Tenant {admin['tenant_id']})")
        
        # 3. T·∫°o Hotel Brands
        print("üè® T·∫°o Hotel Brands...")
        hotel_brands = [
            {
                'tenant_id': grand_hotel_tenant_id, 'hotel_name': 'Grand Palace Hotel',
                'slogan': 'Luxury Beyond Expectation',
                'description': 'Kh√°ch s·∫°n 5 sao h√†ng ƒë·∫ßu v·ªõi d·ªãch v·ª• ƒë·∫≥ng c·∫•p qu·ªëc t·∫ø',
                'address': '123 Tr·∫ßn H∆∞ng ƒê·∫°o, Qu·∫≠n 1, TP.HCM',
                'city': 'H·ªì Ch√≠ Minh', 'phone_number': '+84 28 3822 1234',
                'email': 'info@grandpalace.vn'
            },
            {
                'tenant_id': beach_resort_tenant_id, 'hotel_name': 'Sunset Beach Resort',
                'slogan': 'Where Ocean Meets Paradise', 
                'description': 'Resort bi·ªÉn tuy·ªát ƒë·∫πp v·ªõi view ho√†ng h√¥n l√£ng m·∫°n',
                'address': '789 Nguy·ªÖn ƒê√¨nh Chi·ªÉu, H√†m Ti·∫øn, Phan Thi·∫øt',
                'city': 'B√¨nh Thu·∫≠n', 'phone_number': '+84 252 3847 999',
                'email': 'booking@sunsetbeach.vn'
            }
        ]
        
        for brand in hotel_brands:
            cursor.execute("""
                INSERT INTO tbl_hotel_brands (
                    tenant_id, hotel_name, slogan, description, address, city,
                    phone_number, email, created_at, updated_at, created_by
                ) VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, 'demo_script')
            """, (
                brand['tenant_id'], brand['hotel_name'], brand['slogan'],
                brand['description'], brand['address'], brand['city'],
                brand['phone_number'], brand['email'], current_time, current_time
            ))
            print(f"   ‚úÖ {brand['hotel_name']}")
        
        # 4. T·∫°o Rooms
        print("üõèÔ∏è  T·∫°o Rooms...")
        rooms_data = [
            # Grand Palace Hotel
            {'tenant_id': grand_hotel_tenant_id, 'room_type': 'Deluxe', 'room_name': 'Deluxe City View', 'price': 2500000, 'capacity_adults': 2, 'size_m2': 45},
            {'tenant_id': grand_hotel_tenant_id, 'room_type': 'Suite', 'room_name': 'Executive Suite', 'price': 4500000, 'capacity_adults': 2, 'size_m2': 80},
            {'tenant_id': grand_hotel_tenant_id, 'room_type': 'Presidential', 'room_name': 'Presidential Suite', 'price': 8500000, 'capacity_adults': 4, 'size_m2': 150},
            # Sunset Beach Resort
            {'tenant_id': beach_resort_tenant_id, 'room_type': 'Ocean View', 'room_name': 'Ocean Breeze Room', 'price': 3200000, 'capacity_adults': 2, 'size_m2': 50},
            {'tenant_id': beach_resort_tenant_id, 'room_type': 'Beach Villa', 'room_name': 'Sunset Villa', 'price': 6500000, 'capacity_adults': 4, 'size_m2': 120},
            {'tenant_id': beach_resort_tenant_id, 'room_type': 'Pool Villa', 'room_name': 'Private Pool Villa', 'price': 9500000, 'capacity_adults': 6, 'size_m2': 200}
        ]
        
        for room in rooms_data:
            cursor.execute("""
                INSERT INTO tbl_rooms (
                    tenant_id, room_type, room_name, price, capacity_adults, size_m2,
                    created_at, updated_at, created_by
                ) VALUES (%s, %s, %s, %s, %s, %s, %s, %s, 'demo_script')
            """, (
                room['tenant_id'], room['room_type'], room['room_name'],
                room['price'], room['capacity_adults'], room['size_m2'],
                current_time, current_time
            ))
            print(f"   ‚úÖ {room['room_name']} - {room['price']:,} VND")
        
        # 5. T·∫°o Facilities
        print("üèä T·∫°o Facilities...")
        facilities_data = [
            # Grand Palace Hotel
            {'tenant_id': grand_hotel_tenant_id, 'facility_name': 'Royal Spa & Wellness', 'type': 'spa'},
            {'tenant_id': grand_hotel_tenant_id, 'facility_name': 'Le Grand Restaurant', 'type': 'restaurant'},
            {'tenant_id': grand_hotel_tenant_id, 'facility_name': 'Sky Fitness Center', 'type': 'gym'},
            {'tenant_id': grand_hotel_tenant_id, 'facility_name': 'Rooftop Pool', 'type': 'pool'},
            # Sunset Beach Resort
            {'tenant_id': beach_resort_tenant_id, 'facility_name': 'Ocean Spa', 'type': 'spa'},
            {'tenant_id': beach_resort_tenant_id, 'facility_name': 'Beachside Grill', 'type': 'restaurant'},
            {'tenant_id': beach_resort_tenant_id, 'facility_name': 'Water Sports Center', 'type': 'activity'},
            {'tenant_id': beach_resort_tenant_id, 'facility_name': 'Infinity Pool', 'type': 'pool'}
        ]
        
        for facility in facilities_data:
            cursor.execute("""
                INSERT INTO tbl_facilities (tenant_id, facility_name, type, created_at, updated_at, created_by)
                VALUES (%s, %s, %s, %s, %s, 'demo_script')
            """, (facility['tenant_id'], facility['facility_name'], facility['type'], current_time, current_time))
            print(f"   ‚úÖ {facility['facility_name']}")
        
        # 6. T·∫°o Services
        print("üîß T·∫°o Services...")
        services_data = [
            # Grand Palace Hotel
            {'tenant_id': grand_hotel_tenant_id, 'service_name': 'Airport Transfer', 'category': 'transport', 'price': 500000},
            {'tenant_id': grand_hotel_tenant_id, 'service_name': 'Spa Treatment', 'category': 'spa', 'price': 1200000},
            {'tenant_id': grand_hotel_tenant_id, 'service_name': 'Fine Dining', 'category': 'restaurant', 'price': 800000},
            # Sunset Beach Resort  
            {'tenant_id': beach_resort_tenant_id, 'service_name': 'Sunset Cruise', 'category': 'tour', 'price': 1500000},
            {'tenant_id': beach_resort_tenant_id, 'service_name': 'Massage Therapy', 'category': 'spa', 'price': 900000},
            {'tenant_id': beach_resort_tenant_id, 'service_name': 'Beach BBQ', 'category': 'restaurant', 'price': 650000}
        ]
        
        for service in services_data:
            cursor.execute("""
                INSERT INTO tbl_services (tenant_id, service_name, category, price, created_at, updated_at, created_by)
                VALUES (%s, %s, %s, %s, %s, %s, 'demo_script')
            """, (service['tenant_id'], service['service_name'], service['category'], service['price'], current_time, current_time))
            print(f"   ‚úÖ {service['service_name']} - {service['price']:,} VND")
        
        # 7. T·∫°o Demo Customers
        print("üë• T·∫°o Demo Customers...")
        customers_data = [
            {'tenant_id': grand_hotel_tenant_id, 'name': 'Nguy·ªÖn VƒÉn A', 'phone': '0901234567', 'email': 'nguyenvana@gmail.com'},
            {'tenant_id': grand_hotel_tenant_id, 'name': 'Tr·∫ßn Th·ªã B', 'phone': '0912345678', 'email': 'tranthib@gmail.com'},
            {'tenant_id': grand_hotel_tenant_id, 'name': 'L√™ Ho√†ng C', 'phone': '0923456789', 'email': 'lehoangc@gmail.com'},
            {'tenant_id': beach_resort_tenant_id, 'name': 'Ph·∫°m Minh D', 'phone': '0934567890', 'email': 'phamminhd@gmail.com'},
            {'tenant_id': beach_resort_tenant_id, 'name': 'Ho√†ng Th·ªã E', 'phone': '0945678901', 'email': 'hoangthie@gmail.com'},
            {'tenant_id': beach_resort_tenant_id, 'name': 'V≈© Quang F', 'phone': '0956789012', 'email': 'vuquangf@gmail.com'}
        ]
        
        for customer in customers_data:
            cursor.execute("""
                INSERT INTO tbl_customers (tenant_id, name, phone, email, created_at, updated_at, created_by)
                VALUES (%s, %s, %s, %s, %s, %s, 'demo_script')
            """, (customer['tenant_id'], customer['name'], customer['phone'], customer['email'], current_time, current_time))
            print(f"   ‚úÖ {customer['name']}")
        
        connection.commit()
        
        print("\nüéØ T·∫†O D·ªÆ LI·ªÜU DEMO HO√ÄN T·∫§T!")
        print("=" * 60)
        print("‚úÖ Admin Users: 3")
        print("‚úÖ Tenants: 2")
        print("‚úÖ Hotel Brands: 2")
        print("‚úÖ Rooms: 6")
        print("‚úÖ Facilities: 8") 
        print("‚úÖ Services: 6")
        print("‚úÖ Customers: 6")
        
        print(f"\nüåê URL: http://157.10.199.22/")
        print("üîë T√†i kho·∫£n ƒëƒÉng nh·∫≠p:")
        print("   ‚Ä¢ superadmin / admin123 (Super Admin)")
        print("   ‚Ä¢ admin_grand / admin123 (Grand Palace Hotel)")
        print("   ‚Ä¢ admin_beach / admin123 (Sunset Beach Resort)")
        print("\nüé™ S·∫µn s√†ng cho PRESENTATION! üöÄ")
        
        return True
        
    except Exception as e:
        print(f"‚ùå L·ªói: {e}")
        return False
    finally:
        if 'connection' in locals():
            connection.close()

def main():
    print("üîÑ RESET V√Ä T·∫†O L·∫†I D·ªÆ LI·ªÜU DEMO")
    print("=" * 60)
    
    # B∆∞·ªõc 1: X√≥a d·ªØ li·ªáu c≈©
    if clean_demo_data():
        # B∆∞·ªõc 2: T·∫°o d·ªØ li·ªáu m·ªõi
        create_fresh_demo_data()
    else:
        print("‚ùå Kh√¥ng th·ªÉ x√≥a d·ªØ li·ªáu c≈©!")

if __name__ == "__main__":
    main()
